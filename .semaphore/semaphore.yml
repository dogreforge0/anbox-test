version: v1.0

name: Gmail Account Creation Automation

agent:
  machine:
    type: e1-standard-2  # Adjust this based on the machine type you need
    os_image: ubuntu2004  # You can change this to any other image if needed

blocks:
  - name: Create Gmail Account
    task:
      jobs:
        - name: Automate Gmail Account Creation
          commands:
            - checkout
            - echo "Updating package lists"
            - sudo apt-get update
            - echo "Installing required dependencies"
            - sudo apt-get install -y curl wget unzip

            # Manually install Firefox
            - echo "Downloading and installing Firefox"
            - wget -q -O /tmp/firefox.tar.bz2 "https://download.mozilla.org/?product=firefox-latest&os=linux64&lang=en-US"
            - sudo tar -xjf /tmp/firefox.tar.bz2 -C /opt/

            # Remove existing symbolic link if it exists, then create a new one
            - which firefox
            #- sudo ln -s /opt/firefox/firefox /usr/bin/firefox

            # Install Puppeteer
            - echo "Installing Puppeteer"
            - PUPPETEER_SKIP_DOWNLOAD=true npm install puppeteer

            # Create JavaScript file for Gmail account creation
            - echo "Creating Gmail account creation script"
            - |
              cat <<EOF > create_gmail.js
              const puppeteer = require('puppeteer');

              async function createAccount() {
                  const browser = await puppeteer.launch({
                      headless: false,
                      executablePath: '/opt/firefox/firefox'  # Ensure this path is correct for Firefox
                  });

                  const page = await browser.newPage();
                  await page.goto('https://accounts.google.com/signup');

                  // Wait for the first name input field and type in the details
                  await page.waitForSelector('input[name="firstName"]');
                  await page.type('input[name="firstName"]', 'John');
                  await page.type('input[name="lastName"]', 'Doe');

                  // Generate a random username
                  await page.type('input[name="Username"]', 'john.doe' + Math.floor(Math.random() * 10000));

                  // Set the password and confirm password
                  await page.type('input[name="Passwd"]', 'Password123!');
                  await page.type('input[name="ConfirmPasswd"]', 'Password123!');

                  // Click Next button to proceed with the sign-up
                  await page.click('#accountDetailsNext');
                  await page.waitForNavigation();

                  // Take a screenshot after the page has loaded
                  await page.screenshot({ path: '/tmp/gmail_account_creation.png' });

                  // Close the browser after the task is completed
                  await browser.close();
              }

              // Start the account creation process
              createAccount();
              EOF

            # Run the JavaScript file to automate Gmail account creation
            - echo "Running Gmail account creation script"
            - node create_gmail.js

            # Capture and save the screenshot (if needed for artifacts)
            - echo "Screenshot saved as /tmp/gmail_account_creation.png"
            - artifact push job /tmp/gmail_account_creation.png
